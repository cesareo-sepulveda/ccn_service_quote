<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Heredamos el FORM de la cotizaciÃ³n para reemplazar la subvista de line_ids -->
    <record id="ccn_view_quote_form_filter_products" model="ir.ui.view">
      <field name="name">ccn.quote.form.filter.products</field>
      <field name="model">ccn.service.quote</field>
      <field name="inherit_id" ref="ccn_service_quote.ccn_view_quote_form"/>
      <field name="arch" type="xml">

        <!-- Reemplazamos el <field name="line_ids"/> original por un widget con list/form -->
        <xpath expr="//form//field[@name='line_ids']" position="replace">
          <field name="line_ids" nolabel="1" mode="list,form">
            <list editable="bottom">
              <!-- Filtra rubros a solo los NO internos -->
              <field name="rubro_id" domain="[('internal_only','=',False)]"/>

              <!-- Filtra productos (placeholder + rubro) -->
              <field name="product_id"
                     options="{'no_open': True, 'no_create': True, 'no_create_edit': True}"
                     domain="[('product_tmpl_id.ccn_exclude_from_quote','=',False),
                              ('product_tmpl_id.ccn_rubro_ids.code','in',[context.get('ctx_rubro_code'), rubro_code])]"/>

              <field name="quantity"/>
              <field name="tabulator_percent"/>
              <field name="product_base_price" readonly="1"/>
              <field name="price_unit_final" readonly="1"/>
              <field name="total_price" readonly="1"/>
              <field name="currency_id" invisible="1"/>
            </list>

            <form>
              <group>
                <field name="rubro_id" domain="[('internal_only','=',False)]"/>
                <field name="product_id"
                       options="{'no_open': True, 'no_create': True, 'no_create_edit': True}"
                       domain="[('product_tmpl_id.ccn_exclude_from_quote','=',False),
                                ('product_tmpl_id.ccn_rubro_ids.code','in',[context.get('ctx_rubro_code'), rubro_code])]"/>
                <field name="quantity"/>
                <field name="tabulator_percent"/>
                <field name="product_base_price" readonly="1"/>
                <field name="price_unit_final" readonly="1"/>
                <field name="total_price" readonly="1"/>
              </group>
            </form>
          </field>
        </xpath>

      </field>
    </record>
  </odoo>
